databaseChangeLog:
  - changeSet:
      id: add-fk-authority-user
      author: tudope

      preConditions:
        - onFail: MARK_RAN
        - not:
            foreignKeyConstraintExists:
              foreignKeyName: fk_authority_user
              foreignKeyTableName: authority

      changes:
        - addForeignKeyConstraint:
            baseTableName: authority
            baseColumnNames: user_id
            constraintName: fk_authority_user
            referencedTableName: app_user
            referencedColumnNames: id
            onDelete: CASCADE

      rollback:
        - dropForeignKeyConstraint:
            baseTableName: authority
            constraintName: fk_authority_user

  - changeSet:
      id: add-uq-authority-user-permission
      author: tudope

      preConditions:
        - onFail: MARK_RAN
        - not:
            uniqueConstraintExists:
              constraintName: uq_authority_user_permission
              tableName: authority

      changes:
        - addUniqueConstraint:
            tableName: authority
            columnNames: user_id, permission
            constraintName: uq_authority_user_permission

      rollback:
        - dropUniqueConstraint:
            tableName: authority
            constraintName: uq_authority_user_permission

  - changeSet:
      id: create-idx-authority-user-id
      author: tudope

      preConditions:
        - onFail: MARK_RAN
        - not:
            indexExists:
              indexName: idx_authority_user_id
              tableName: authority

      changes:
        - createIndex:
            tableName: authority
            indexName: idx_authority_user_id
            columns:
              - column:
                  name: user_id

      rollback:
        - dropIndex:
            tableName: authority
            indexName: idx_authority_user_id
